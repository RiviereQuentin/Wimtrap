#Focus on the ChIP-seq obtained in plantlets
library(wimtrap)
library(XVector)
pfm <- "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/PFMs/Sl_pfm.jaspar"
#Initialize the variables
organism = "Solanum lycopersicum"
genome_sequence = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Genome/Solanum_lycopersicum_ITAG2.4.fa"
tss = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_TSS.bed"
tts = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_TTS.bed"
promoter = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_Promoter.bed"
x5utr = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_X5UTR.bed"
cds = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_CDS.bed"
intron = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_Intron.bed"
x3utr = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_X3UTR.bed"
downstream = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_Downstream.bed"
conserved_elements = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Conservation/Sl_CE.bed"
otherFeatures = c(H3K27me3_ripening = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/HistonesMarks/Sl_H3K27me3.bed",
                  DNAme_ripening = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/CpG/Sl_methylome_peaks.bed",
                  DGF_ripening = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/DGF/Sl_DGF_ripening.bed",
                  H3K27me3_immature = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/HistonesMarks/Sl_H3K27me3_immature.bed",
                  DNAme_immature = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/CpG/Sl_methylome_peaks_immature.bed",
                  DHS_immature = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/DHS/Sl_DHS_immature.bed"
)
ChIPpeaks <- c(RIN = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/TF/RIN.bed",
               EIN3 = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/TF/EIN3.bed",
               TAGL1 = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/TF/TAGL1.bed",
               FUL1 = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/TF/FUL1.bed",
               FUL2 = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/TF/FUL2.bed"
)
dhs = c(seedling = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/DHS/Sl_DHS.bed")
groupTFbyDHS <- data.frame(TFNames = names(ChIPpeaks),
                           DHS = "seedling"
)
smoothing_window = 1
default_value_when_missing = 0
promoterLength = 1500
downstreamLength = 1500
proportionTF_Validation = 0.5
strandAsFeature = TRUE
DNAregionsName = "Motifs"
pvalThreshold = 10^-3
matches <- NULL
TF4Validation <- NULL
TFspecific <- FALSE
proximalLength <- 300

ChIPpeaks <- c(NAC5 = "/home/quentin/Documents/Wimtrap2.0/Source/Oryza sativa japonica/TF/NAC5/NAC5.bed",
               NAC6 = "/home/quentin/Documents/Wimtrap2.0/Source/Oryza sativa japonica/TF/NAC6/NAC6.bed",
               NAC9 = "/home/quentin/Documents/Wimtrap2.0/Source/Oryza sativa japonica/TF/NAC9/NAC9.bed",
               NAC10 = "/home/quentin/Documents/Wimtrap2.0/Source/Oryza sativa japonica/TF/NAC10/NAC10.bed"
)

otherFeatures = c(ActH3K4me3 = "/home/quentin/Documents/Wimtrap2.0/Source/Oryza sativa japonica/HistonesMarks/TIGR7_Osj_H3K4me3_root.bed",
                  ActH3K9ac = "/home/quentin/Documents/Wimtrap2.0/Source/Oryza sativa japonica/HistonesMarks/TIGR7_Osj_H3K9ac_root.bed",
                  ActH3K36me3 = "/home/quentin/Documents/Wimtrap2.0/Source/Oryza sativa japonica/HistonesMarks/TIGR7_Osj_H3K36me3_root.bed",
                  AmbH4K12ac = "/home/quentin/Documents/Wimtrap2.0/Source/Oryza sativa japonica/HistonesMarks/TIGR7_Osj_H4K12ac_root.bed",
                  RepH3K27me3 = "/home/quentin/Documents/Wimtrap2.0/Source/Oryza sativa japonica/HistonesMarks/TIGR7_Osj_H3K27me3_root.bed",
                  RepH3K27ac = "/home/quentin/Documents/Wimtrap2.0/Source/Oryza sativa japonica/HistonesMarks/TIGR7_Osj_H3K27ac_root.bed",
                  CpG = "/home/quentin/Documents/Wimtrap2.0/Source/Oryza sativa japonica/CpG/Osj_CpG_root.bed"
)

dhs = c(seedling = "/home/quentin/Documents/Wimtrap2.0/Source/Oryza sativa japonica/DHS/Osj_TnHS_root.bed")
groupTFbyDHS <- data.frame(TFNames = names(ChIPpeaks),
                           DHS = "seedling"
)

test <- buildTFBSmodel_custom(organism,
                              ChIPpeaks,
                              genome_sequence,
                              pfm,tss,
                              promoter,
                              x5utr,
                              cds,
                              intron,
                              x3utr,
                              downstream,
                              dhs,
                              groupTFbyDHS,
                              conserved_elements,
                              otherFeatures,
                              matches,
                              smoothing_window,
                              default_value_when_missing,
                              promoterLength,
                              downstreamLength,
                              proportionTF_Validation,
                              strandAsFeature,
                              pvalThreshold,
                              TFspecific,
                              TF4Validation,
                              targetsROC)
evalxgb <- function(xgbresult){
  xgbpred <- ifelse(xgbresult$validation > 0.5,1,0)
  cat("Performances of the model\n")
  print(caret::confusionMatrix(as.factor(xgbpred), as.factor(xgbresult$response)))
  mat <- xgboost::xgb.importance(model = xgbresult$model)
  cat("Features importance")
  print(mat)
  xgboost::xgb.plot.importance(importance_matrix = mat[1:35])
  pdf(file = paste0( "out.pdf"), width = 8.27, height = 11.67, pointsize = 10)
  plot(pROC::roc(xgbresult$response, xgbresult$validation))
  lines(pROC::roc(xgbresult$response, xgbresult$pm), col = "red")
  legend(x = "bottom", legend = c("Model", "P-M"), fill = c("black", "red"))
  mtext(text = round(pROC::auc(xgbresult$response, xgbresult$validation), 2), side = 2)
  dev.off()
}


PWMmatches <- getPWMmatches(pfms = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/PFMs/Sl_pfm.jaspar",
                      genome =  "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Genome/Solanum_lycopersicum_ITAG2.4.fa",
                      ChIPpeaks = c(RIN = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/TF/RIN.bed",
                                    EIN3 = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/TF/EIN3.bed",
                                    TAGL1 = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/TF/TAGL1.bed",
                                    FUL1 = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/TF/FUL1.bed",
                                    FUL2 = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/TF/FUL2.bed"
                      ),
                      tss = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_TSS.bed",
                      tts = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_TTS.bed",
                      maxDistToTSS = 5000,
                      maxDistToTTS = 5000)
#Test the prediction functionalities
sourceAnnotations <- inputSource(
  genomic_annotations = c(ConservedElement = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Conservation/Sl_CE.bed",
                          H3K27me3_ripening = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/HistonesMarks/Sl_H3K27me3.bed",
                          DNAme_ripening = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/CpG/Sl_methylome_peaks.bed",
                          H3K27me3_immature = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/HistonesMarks/Sl_H3K27me3_immature.bed",
                          DNAme_immature = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/CpG/Sl_methylome_peaks_immature.bed",
                          DHS_immature = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/DHS/Sl_DHS_immature.bed",
                          DHS = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/DHS/Sl_DHS.bed"),
  promoterLength = 1500,
  proximalPromoterLength = 300,
  downstreamLength = 1500,
  tss = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_TSS.bed",
  tts = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_TTS.bed",
  x5utr = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_X5UTR.bed",
  cds = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_CDS.bed",
  intron = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_Intron.bed",
  x3utr = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Structures/Sl_X3UTR.bed"
)
data <- data.table::fread("/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/TomatoRipeninngFruit_DataSe.tsv")
colnames(data)[which(colnames(data)=="closestTTS")] <- "ClosestTTS"
data <- data[,-grep("DGF", colnames(data)), with = F]
ModelTFBS <- xgbmodeling(data, TF4Validation = NULL, TFspecific = FALSE)$model
ChIPpeaks <- c(RIN = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/TF/RIN.bed")
ChIP_regions <- listChIPRegions(ChIP_paths = ChIPpeaks, 400)
GRanges <- GenomicRanges::makeGRangesFromDataFrame(
  data.frame(seqname = "1",
             start = 94385026 - 2000,
             end = 94389498,
             name = "Solyc01g106750.2.1"
             ),
  keep.extra.columns = TRUE
)
TFBScandidates <- getPWMmatches(pfms = "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/PFMs/Sl_pfm.jaspar",
                            genome =  "/home/quentin/Documents/Wimtrap2.0/Source/Solanum lycopersicum/Genome/Solanum_lycopersicum_ITAG2.4.fa",
                            GRanges = GRanges)
contextualized <- contextualizePWMmatches(TFBScandidates, sourceAnnotations)
colnames(contextualized)[!(colnames(contextualized) %in% ModelTFBS$feature_names)]
ModelTFBS$feature_names[!(ModelTFBS$feature_names %in% colnames(contextualized))]
